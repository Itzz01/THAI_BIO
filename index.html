<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thai‑Bio Skin Quiz — เล่นเกมวิเคราะห์ผิว</title>
  <style>
    :root{--bg:#f7f8fb;--card:#ffffff;--ink:#111827;--muted:#6b7280;--accent:#23a36d;--accent-2:#0ea5e9}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    .wrap{max-width:920px;margin:0 auto;padding:24px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.06);overflow:hidden}
    header.hero{padding:28px 24px;border-bottom:1px solid #eef1f6;display:flex;gap:16px;align-items:center}
    .logo{width:56px;height:56px;border-radius:14px;overflow:hidden}
    .logo img{width:100%;height:100%;object-fit:contain}
    h1{font-size:24px;margin:0}
    .muted{color:var(--muted)}
    .content{padding:20px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}
    .panel{padding:18px;border:1px solid #eef2f7;border-radius:14px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 16px;border-radius:12px;border:1px solid transparent;background:var(--accent);color:#fff;font-weight:600;cursor:pointer}
    .btn.alt{background:#fff;color:var(--ink);border-color:#e5e7eb}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .q{margin:4px 0 10px;font-weight:700;font-size:20px}
    .choice{display:block;padding:12px 14px;border:1px solid #e5e7eb;border-radius:12px;margin:8px 0;background:#fff;cursor:pointer;font-size:18px}
    .choice input{margin-right:8px}
    .footer{border-top:1px solid #eef1f6;padding:16px 20px;display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between}
    .consent{font-size:13px;line-height:1.35;color:var(--muted)}
    .consent a{color:var(--accent-2);text-decoration:none}
    .badge{display:inline-block;background:#ecfeff;color:#0369a1;font-weight:700;border-radius:999px;padding:6px 10px;font-size:14px}
    .scorebar{height:10px;background:#eef2f7;border-radius:999px;overflow:hidden}
    .scorebar>span{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#10b981);width:0%}
    .hidden{display:none}
    .note{font-size:16px;color:#64748b}
    .pill{display:inline-block;padding:6px 10px;background:#f1f5f9;border-radius:999px;margin:4px 6px 0 0;font-size:14px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="app">
      <header class="hero">
        <div class="logo"><img src="https://cdn.discordapp.com/attachments/1422488632358473789/1422489994345451530/Thai-Bio---Logo.png?ex=68dcdc8b&is=68db8b0b&hm=5fae950f6166c1c02b1824a6662e704051742f145c3ca48085c7c2afe82dc930" alt="Thai‑Bio Logo"></div>
        <div>
          <h1>เล่นเกมวิเคราะห์ผิว — Thai‑Bio Skin Quiz</h1>
          <div class="muted">ตอบคำถาม 2–3 นาที แล้วรับคำแนะนำตามแนวทาง <strong>สมดุลสะเก็ดเงิน</strong> + ลุ้นสินค้าทดลอง</div>
        </div>
      </header>

      <div class="content">
        <!-- Intro / Consent -->
        <section id="intro">
          <div class="grid">
            <div class="panel">
              <p class="q">เริ่มเกมกันเลยไหม?</p>
              <div class="panel" style="background:#f8fffb;border-color:#d1fae5">
                <div class="q">การยินยอม (จำเป็น)</div>
                <label class="choice"><input type="checkbox" id="agree" /> ฉันยินยอมให้ Thai‑Bio เก็บและใช้ข้อมูลคำตอบของฉันตาม <a href="#" onclick="alert('ใส่ลิงก์นโยบายความเป็นส่วนตัวของคุณที่นี่'); return false;">นโยบายความเป็นส่วนตัว</a></label>
                <div class="note">คุณสามารถถอนความยินยอมได้ทุกเมื่อ และเราจะไม่เก็บข้อมูลที่ไม่จำเป็น</div>
              </div>
              <div style="margin-top:12px;display:flex;gap:8px">
                <button class="btn" id="startBtn" disabled>เริ่มเล่น</button>
                <button class="btn alt" id="previewBtn">ดูตัวอย่างคำถาม</button>
              </div>
            </div>
            <div class="panel">
              <div class="q">ของรางวัลประจำสัปดาห์</div>
              <ul class="note">
                <li>Top 10 คะแนนสูงสุด รับโค้ดส่วนลดพิเศษ</li>
                <li>สุ่มผู้โชคดี 5 คน รับมินิไซส์ทดลอง</li>
              </ul>
              <div class="scorebar" aria-hidden="true"><span id="progress"></span></div>
              <div style="margin-top:8px" class="muted">ความคืบหน้า: <span id="pLabel">0%</span></div>
            </div>
          </div>
        </section>

        <!-- Quiz -->
        <section id="quiz" class="hidden"></section>

        <!-- Result -->
        <section id="result" class="hidden"></section>
      </div>

      <div class="footer">
        <div class="consent">© Thai‑Bio — โปร่งใส เคารพความเป็นส่วนตัว เก็บเท่าที่จำเป็นเท่านั้น</div>
        <div class="badge" id="badge">โหมด: สาธารณะ</div>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbyYpEeYD4u8T7XQnpZF3iJv4DtIhK9PPQ5oW-KqOO7gvmUpTZFtNyI7ScsPPkj_mgLebg/exec"; // ใส่ลิงก์ /exec ของคุณ
    const GAME_ID = "THAI-BIO";

    // ===== 7 คำถาม =====
    const QUESTIONS = [
      { id:"age", q:"อายุของคุณอยู่ช่วงไหน?", type:"single", choices:[
        {v:"<20", t:"ต่ำกว่า 20"},{v:"20-29", t:"20–29"},{v:"30-39", t:"30–39"},{v:"40-49", t:"40–49"},{v:"50+", t:"50+"}
      ]},
      { id:"skin", q:"สภาพผิวโดยรวมเป็นแบบไหน? (เลือกได้มากกว่า 1 ข้อ)", type:"multi", choices:[
        {v:"dry_tight", t:"แห้ง/ตึง"},{v:"hard_flake", t:"เป็นขุยแข็ง"},{v:"red_inflamed", t:"แดง/อักเสบ"},{v:"easy_allergy", t:"ผิวแพ้"}
      ]},
      { id:"sens", q:"ระดับผิวแพ้/ระคายเคืองช่วง 1 เดือนที่ผ่านมา", type:"single", choices:[
        {v:"low", t:"น้อย"},{v:"mid", t:"ปานกลาง"},{v:"high", t:"ค่อนข้างมาก"}
      ]},
      { id:"sym", q:"อาการที่คุณพบเจอบ่อย (เลือกได้มากกว่า 1)", type:"multi", choices:[
        {v:"itch", t:"คัน"},{v:"red", t:"แดง"},{v:"flake", t:"ลอก/ขุย"},{v:"tight", t:"ตึง"},{v:"scalp", t:"หนังศีรษะแพ้"}
      ]},
      { id:"trig", q:"ตัวกระตุ้นที่สังเกตได้ (เลือกได้มากกว่า 1 ข้อ)", type:"multi", choices:[
        {v:"hot_cold", t:"อากาศร้อน / อากาศหนาว"},{v:"stress", t:"เครียด/พักผ่อนไม่พอ"},{v:"food", t:"อาหารบางชนิด"},{v:"chem", t:"สารระคายเคือง/น้ำหอม"}
      ]},
      { id:"goal", q:"เป้าหมายหลักของคุณ (เลือกได้มากกว่า 1)", type:"multi", choices:[
        {v:"calm", t:"ลดคัน/แดง/ระคายเคือง"},{v:"hydrate", t:"ชุ่มชื้นยาวนาน"},{v:"barrier", t:"ฟื้นเกราะผิวให้ไม่แพ้"},{v:"flake_reduce", t:"ลดขุยหลุดร่วง"}
      ]},
      { id:"pref", q:"ช่องทางที่สะดวกให้ทีมงานติดต่อกลับ?", type:"single", choices:[
        {v:"none", t:"ยังไม่สะดวก"},{v:"line", t:"LINE"},{v:"email", t:"อีเมล"}
      ]}
    ];

    // ===== คำนวณ persona =====
    function computePersona(ans){
      const score = { calm:0, hydrate:0, barrier:0 };

      // รองรับเป้าหมายหลายข้อ
      const goals = Array.isArray(ans.goal) ? ans.goal : (ans.goal ? [ans.goal] : []);
      for(const g of goals){ if(score[g]!==undefined) score[g] += 2; }

      // ผิว (multi)
      const skinArr = ans.skin || [];
      if(skinArr.includes('dry_tight')) score.hydrate++;
      if(skinArr.includes('hard_flake')) score.hydrate++;
      if(skinArr.includes('red_inflamed')) { score.calm += 2; score.barrier++; }
      if(skinArr.includes('easy_allergy')) score.barrier++;

      // อาการ (multi)
      if((ans.sym||[]).includes('flake')) score.hydrate++;
      if((ans.sym||[]).includes('tight')) score.barrier++;

      const key = Object.entries(score).sort((a,b)=>b[1]-a[1])[0][0];

      // แผนคำแนะนำตามแนวสมดุลสะเก็ดเงิน + ตำแหน่ง O.C.O แบบ Premium
      const map = {
        calm: {
          name: "Calm & Soothe",
          tips: [
            "ใช้ครีมสมุนไพรอ่อนโยน เช่น น้ำมันมะพร้าวสกัดเย็น และครีมสมุนไพรของ Thai‑Bio",
            "แต้มบริเวณคัน‑แดง วันละ 2–3 ครั้ง",
            "เลี่ยงความเครียด/อากาศสุดขั้ว และปัจจัยกระตุ้นอื่น ๆ"
          ],
          rec: [
            "Thai‑bio Skin Care Cream",
            "Thai‑bio Hair Tonic (ถ้ามีคันหรือขุยบนหนังศีรษะ)",
            "Thai‑bio Mild Shampoo",
            "Thai‑bio Mild Shower"
          ],
          food: [
            "หลีกเลี่ยงหลัก: นมวัว, แป้งสาลี/กลูเตน (เช่น ขนมปัง, บะหมี่กึ่งสำเร็จรูป)",
            "เพิ่มผักผลไม้ครบสี โปรตีนสะอาด (ปลา ไข่ ถั่ว) และไขมันดี",
            "สังเกตอาหารกระตุ้นส่วนบุคคลและจดบันทึก"
          ]
        },
        hydrate: {
          name: "Deep Hydration",
          tips: [
            "ทามอยส์เจอร์ทันทีหลังอาบน้ำ",
            "เสริมชุ่มชื้นระหว่างวันบริเวณตึง/ลอก",
            "ใช้ผลิตภัณฑ์ที่มี Pentavitin (ชุ่มชื้นยาวนาน ~72 ชม.) และ Hyaluronic Acid"
          ],
          rec: [
            "Thai‑bio Intensive Moisturizing Body Lotion",
            "Thai‑bio Intensive Moisturizing Facial Emulsion",
            "Thai‑bio Body Lotion",
            "OCO Ozonated Coconut Oil"
          ],
          food: [
            "หลีกเลี่ยงหลัก: นมวัว, แป้งสาลี/กลูเตน (เช่น ขนมปัง, บะหมี่กึ่งสำเร็จรูป)",
            "เพิ่มผักผลไม้ครบสี โปรตีนสะอาด และโอเมก้า‑3 จากปลา/ถั่ว/งา",
            "สังเกตอาหารกระตุ้นส่วนบุคคลและจดบันทึก"
          ]
        },
        barrier: {
          name: "Barrier First",
          tips: [
            "เลือกสูตรเสริมเกราะผิว เช่น Pentavitin (ชุ่มชื้น ~72 ชม.) + Hyaluronic Acid (กักเก็บน้ำ)",
            "เลี่ยงน้ำหอม/แอลกอฮอล์แรง",
            "ทาต่อเนื่องอย่างน้อย 14 วัน"
          ],
          rec: [
            "Thai‑bio Skin Care Cream",
            "OCO Ozonated Coconut Oil",
            "Thai‑bio Intensive Moisturizing Facial Emulsion",
            "Thai‑bio Intensive Moisturizing Body Lotion"
          ],
          food: [
            "หลีกเลี่ยงหลัก: นมวัว, แป้งสาลี/กลูเตน (เช่น ขนมปัง, บะหมี่กึ่งสำเร็จรูป)",
            "โฟกัสอาหารจริง ลดน้ำตาลสูง และเพิ่มสังกะสี/วิตามินดีอย่างเหมาะสม",
            "สังเกตอาหารกระตุ้นส่วนบุคคลและจดบันทึก"
          ]
        }
      };
      return { key, ...map[key], raw: score };
    }

    // ===== State =====
    const state = { step:0, answers:{}, started:false };
    const $ = (s)=>document.querySelector(s);
    const intro = $('#intro');
    const quiz = $('#quiz');
    const result = $('#result');
    const progress = $('#progress');
    const pLabel = $('#pLabel');

    // ===== Events =====
    // ทำให้ปุ่มเริ่มเล่นเชื่อถือได้มากขึ้น แม้บางครั้ง listener จะไม่ผูกเพราะแคช
    const agreeEl = document.getElementById('agree');
    const startBtn = document.getElementById('startBtn');
    const previewBtn = document.getElementById('previewBtn');

    function updateStart(){
      try{ startBtn.disabled = !agreeEl.checked; }catch(_){/* noop */}
    }
    // อัปเดตครั้งแรกและทุกครั้งที่มีการเปลี่ยนแปลง
    updateStart();
    if(agreeEl) agreeEl.addEventListener('change', updateStart);

    if(previewBtn) previewBtn.addEventListener('click', ()=>{
      alert('ตัวอย่างคำถาม: สภาพผิว (เลือกหลายข้อ), อาการ, ตัวกระตุ้น, เป้าหมาย (เลือกหลายข้อ), ช่องทางติดต่อ');
    });

    if(startBtn) startBtn.addEventListener('click', ()=>{
      // ป้องกันกรณี disabled ค้าง ให้ตรวจจาก checkbox จริง
      if(!agreeEl || !agreeEl.checked){ alert('โปรดติ๊กยินยอมก่อนเริ่มเล่น'); return; }
      state.started = true; state.step = 0; state.answers = {};
      intro.classList.add('hidden');
      quiz.classList.remove('hidden');
      renderStep();
    });

    function renderStep(){
      const i = state.step, total = QUESTIONS.length, q = QUESTIONS[i];
      progress.style.width = Math.round((i/total)*100)+"%";
      pLabel.textContent = Math.round((i/total)*100)+"%";
      quiz.innerHTML = `
        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
            <div class="badge">ข้อ ${i+1} / ${total}</div>
            <button class="btn alt" onclick="quitGame()">ออกจากเกม</button>
          </div>
          <h2 class="q" style="margin-top:12px">${q.q}</h2>
          <div>${renderChoices(q)}</div>
          <div style="margin-top:14px;display:flex;gap:8px">
            <button class="btn alt" onclick="prevStep()" ${i===0?'disabled':''}>ย้อนกลับ</button>
            <button class="btn" onclick="nextStep()">ถัดไป</button>
          </div>
        </div>`;
    }

    function renderChoices(q){
      if(q.type === 'single'){
        return q.choices.map(c=>`<label class="choice"><input type="radio" name="${q.id}" value="${c.v}"> ${c.t}</label>`).join('');
      } else {
        return q.choices.map(c=>`<label class="choice"><input type="checkbox" name="${q.id}" value="${c.v}"> ${c.t}</label>`).join('');
      }
    }

    window.prevStep = function(){ if(state.step>0){ state.step--; renderStep(); } }

    window.nextStep = function(){
      const q = QUESTIONS[state.step];
      const inputs = [...document.querySelectorAll(`[name="${q.id}"]`)];
      if(q.type==='single'){
        const pick = inputs.find(i=>i.checked);
        if(!pick){ alert('โปรดเลือกตัวเลือก'); return; }
        state.answers[q.id] = pick.value;
      } else {
        const picks = inputs.filter(i=>i.checked).map(i=>i.value);
        if(picks.length===0){ alert('โปรดเลือกอย่างน้อย 1 ตัวเลือก'); return; }
        state.answers[q.id] = picks;
      }
      if(state.step < QUESTIONS.length-1){ state.step++; renderStep(); } else { finish(); }
    }

    function quitGame(){ if(confirm('ต้องการออกจากเกมหรือไม่?')) location.reload(); }

    async function finish(){
      quiz.classList.add('hidden');
      progress.style.width = '100%'; pLabel.textContent = '100%';
      const persona = computePersona(state.answers);
      const ts = new Date().toISOString();
      const payload = { game:GAME_ID, ts, answers:state.answers, persona:persona.key, consent:true, ua:navigator.userAgent };

      result.classList.remove('hidden');
      result.innerHTML = `
        <div class="panel">
          <h2 style="margin:0 0 6px;font-size:22px">โปรไฟล์ผิวของคุณ: <span class="pill">${persona.name}</span></h2>
          <div class="note">คำแนะนำตามแนวทางสมดุลสะเก็ดเงิน</div>

          <div style="margin-top:16px">
            <div class="q" style="font-size:20px">ทริคดูแลผิว</div>
            <ul class="note">${persona.tips.map(t=>`<li>${t}</li>`).join('')}</ul>
          </div>

          <div style="margin-top:12px">
            <div class="q" style="font-size:20px">อาหารที่แนะนำ</div>
            <ul class="note">${persona.food.map(f=>`<li>${f}</li>`).join('')}</ul>
          </div>

          <div style="margin-top:12px">
            <div class="q" style="font-size:20px">สินค้าแนะนำ</div>
            <div>${persona.rec.map(r=>`<span class="pill">${r}</span>`).join(' ')}</div>
          </div>

          <div style="margin-top:18px" class="panel">
            <div class="q" style="font-size:20px">ข้อมูลสำหรับรับรางวัล/สินค้าทดลอง</div>
            <div class="note">กรอกข้อมูลติดต่อ เพื่อให้ทีมงานติดต่อยืนยันการรับรางวัลหรือสินค้าทดลอง</div>
            <form id="contactForm">
              <label class="choice">ชื่อ: <input type="text" name="first_name" placeholder="ชื่อ" style="margin-left:8px"></label>
              <label class="choice">นามสกุล: <input type="text" name="last_name" placeholder="นามสกุล" style="margin-left:8px"></label>
              <label class="choice">เบอร์โทรติดต่อ: <input type="tel" name="phone" placeholder="08x-xxx-xxxx" style="margin-left:8px"></label>
              <div class="q" style="margin-top:8px">เลือกรับการติดต่อ (อย่างน้อย 1 ช่องทาง)</div>
              <label class="choice"><input type="checkbox" name="use_line" value="1"> LINE ID: <input type="text" name="line_id" placeholder="@thai-bio หรือ ID ของคุณ" style="margin-left:8px"></label>
              <label class="choice"><input type="checkbox" name="use_email" value="1"> อีเมล: <input type="email" name="email" placeholder="you@example.com" style="margin-left:8px"></label>
              <label class="choice"><input type="checkbox" name="marketing" checked> ยินยอมรับข่าวสาร/ข้อเสนอการตลาดจาก Thai‑Bio</label>
              <div class="note">ข้อมูลของคุณจะถูกใช้เพื่อการติดต่อเรื่องรางวัล/สินค้าทดลองและข้อเสนอที่เกี่ยวข้องเท่านั้น คุณสามารถยกเลิกได้ทุกเมื่อ</div>
              <div style="margin-top:10px;display:flex;gap:8px">
                <button class="btn" type="submit">บันทึก & ขอรับรางวัล</button>
                <button class="btn alt" type="button" onclick="location.reload()">เล่นใหม่</button>
              </div>
            </form>
            <div id="thanks" class="hidden" style="margin-top:10px">
              <span class="pill">บันทึกแล้ว</span> ขอบคุณ! ทีมงานจะติดต่อกลับเร็ว ๆ นี้
            </div>
          </div>
        </div>`;

      // ยิงผลตอบจบเกม (ไม่มีข้อมูลติดต่อ)
      try{ await postData(ENDPOINT, payload); } catch(err){ console.warn('ส่งคำตอบไม่สำเร็จ:', err); }

      // ฟังบันทึกข้อมูลติดต่อ
      document.getElementById('contactForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const fd = new FormData(e.target);
        const data = Object.fromEntries(fd.entries());
        const wantLine = !!data.use_line;
        const wantEmail = !!data.use_email;
        if(!data.phone || data.phone.trim().length < 9){ alert('โปรดกรอกเบอร์โทรที่ติดต่อได้'); return; }
        if(!(wantLine || wantEmail)) { alert('โปรดเลือกอย่างน้อย 1 ช่องทาง (LINE หรือ อีเมล)'); return; }
        if(wantLine && !data.line_id){ alert('โปรดกรอก LINE ID'); return; }
        if(wantEmail && !data.email){ alert('โปรดกรอกอีเมล'); return; }
        const contact = { first_name:data.first_name||'', last_name:data.last_name||'', phone:data.phone||'', line_id: wantLine? (data.line_id||''): '', email: wantEmail? (data.email||''): '' };
        const marketing = !!data.marketing;
        const body = { ...payload, contact_channel:(wantLine&&wantEmail?'line,email': wantLine?'line':'email'), contact, marketing_opt_in:marketing, sample_request:true };
        try{ await postData(ENDPOINT, body); document.getElementById('thanks').classList.remove('hidden'); } catch(err){ alert('บันทึกไม่สำเร็จ ลองใหม่อีกครั้ง'); }
      });
    }

    async function postData(url, data){
      const res = await fetch(url, { method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(data) });
      if(!res.ok) throw new Error('Network error');
      return res.text();
    }

    // ===== SELF TESTS (ไม่รบกวนผู้ใช้ แต่อ่านได้ใน Console) =====
    (function selfTests(){
      try {
        console.assert(Array.isArray(QUESTIONS) && QUESTIONS.length===7, 'TEST: QUESTIONS length should be 7');
        console.assert(QUESTIONS[5].id==='goal' && QUESTIONS[5].type==='multi', 'TEST: Q6 goal must be multi');
        const p1 = computePersona({goal:['calm','hydrate'], skin:['red_inflamed'], sym:['flake']});
        console.assert(['calm','hydrate','barrier'].includes(p1.key), 'TEST: persona key invalid #1');
        const p2 = computePersona({goal:'barrier', skin:['easy_allergy']});
        console.assert(['calm','hydrate','barrier'].includes(p2.key), 'TEST: persona key invalid #2');
        console.log('%cSelf‑tests passed','color:green');
      } catch(e) {
        console.error('Self‑tests error', e);
      }
    })();
  </script>
</body>
</html>

